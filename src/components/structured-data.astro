---
import iconUrl from "@/assets/icon.svg?no-inline";
import ogImageUrl from "@/assets/og-image.png?url";
import { siteConfig } from "@/lib/site-config";
import type { Feature, PricingTier, Step } from "@/types";

interface Breadcrumb {
  name: string;
  path: string;
}

interface BaseProps {
  breadcrumbs: Breadcrumb[];
}

type WebsiteProps = BaseProps & { type: "website" };
type WebAppProps = BaseProps & {
  type: "webapp";
  pricingTiers: PricingTier[];
  features: Feature[];
  steps: Step[];
};
type Props = WebsiteProps | WebAppProps;

const props = Astro.props;
const { breadcrumbs } = props;
const isWebApp = props.type === "webapp";

const siteUrl = Astro.site!.href;
const ogImageURL = new URL(ogImageUrl, Astro.site!).href;
const logoURL = new URL(iconUrl, Astro.site!).href;

// Entity ID generators
const authorId = () => `${siteConfig.author.website}#me`;
const logoId = () => `${siteUrl}#logo`;
const organizationId = () => `${siteUrl}#organization`;
const softwareId = () => `${siteUrl}#software`;
const screenshotId = () => `${siteUrl}#screenshot`;
const websiteId = () => `${siteUrl}#website`;

// Entity reference generators
const authorRef = () => ({ "@id": authorId() });
const logoRef = () => ({ "@id": logoId() });
const organizationRef = () => ({ "@id": organizationId() });

// Reusable ImageObject for the logo
const logoImageSchema = {
  "@type": "ImageObject",
  "@id": logoId(),
  url: logoURL,
  width: "512",
  height: "512",
};

// Organization schema per https://schema.org/Organization
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "@id": organizationId(),
  name: siteConfig.name,
  url: siteUrl,
  logo: logoImageSchema,
  description: siteConfig.description,
  founder: authorRef(),
  sameAs: [siteConfig.links.chromeWebStore],
};

// Offer schema per https://schema.org/Offer
const offers = isWebApp
  ? props.pricingTiers.map((tier) => ({
      "@type": "Offer",
      name: tier.name,
      description: tier.features.join(", "),
      price: tier.price.toString(),
      priceCurrency: siteConfig.pricing.currency,
      availability: "https://schema.org/InStock",
      url: `${siteUrl}#pricing`,
      seller: organizationRef(),
      priceSpecification: {
        "@type": "PriceSpecification",
        price: tier.price.toString(),
        priceCurrency: siteConfig.pricing.currency,
        valueAddedTaxIncluded: true,
      },
    }))
  : [];

const featureList = isWebApp
  ? props.features.map((feature) => feature.title)
  : [];

// WebApplication schema per https://schema.org/WebApplication
const webApplicationSchema = {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "@id": softwareId(),
  name: siteConfig.name,
  description: siteConfig.description,
  url: siteUrl,
  applicationCategory: "BrowserApplication",
  applicationSubCategory: "Productivity",
  operatingSystem: "Windows, macOS, Linux, Chrome OS",
  browserRequirements:
    "Requires a Chromium-based browser (e.g. Chrome, Edge, Brave)",
  offers,
  featureList,
  downloadUrl: siteConfig.links.chromeWebStore,
  installUrl: siteConfig.links.chromeWebStore,
  screenshot: {
    "@type": "ImageObject",
    "@id": screenshotId(),
    url: ogImageURL,
    width: "1200",
    height: "630",
  },
  image: logoRef(),
  author: authorRef(),
  publisher: organizationRef(),
  softwareHelp: {
    "@type": "WebPage",
    "@id": siteUrl,
    url: siteUrl,
    name: `${siteConfig.name} Help`,
  },
};

// BreadcrumbList schema per https://schema.org/BreadcrumbList
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: breadcrumbs.map((breadcrumb, index) => ({
    "@type": "ListItem",
    position: index + 1,
    item: {
      "@id": new URL(breadcrumb.path, Astro.site!).href,
      name: breadcrumb.name,
    },
  })),
};

// WebSite schema per https://schema.org/WebSite
const webSiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "@id": websiteId(),
  name: siteConfig.name,
  url: siteUrl,
  description: siteConfig.description,
  publisher: organizationRef(),
  inLanguage: siteConfig.locale,
};

// HowTo schema per https://schema.org/HowTo
const howToSchema = isWebApp
  ? {
      "@context": "https://schema.org",
      "@type": "HowTo",
      name: "How to use Clipwise AI to convert webpages to Markdown",
      description:
        "Convert any webpage to clean Markdown for AI assistants in three simple steps",
      image: ogImageURL,
      totalTime: "PT1M",
      estimatedCost: {
        "@type": "MonetaryAmount",
        currency: siteConfig.pricing.currency,
        value: "0",
      },
      tool: [
        {
          "@type": "HowToTool",
          name: "Clipwise AI Chrome Extension",
        },
        {
          "@type": "HowToTool",
          name: "Chromium-based browser (Chrome, Edge, Brave)",
        },
      ],
      step: props.steps.map((step, index) => ({
        "@type": "HowToStep",
        position: String(index + 1),
        name: step.title,
        text: step.description,
        url: `${siteUrl}#how-it-works`,
      })),
    }
  : null;

const schemas = [
  organizationSchema,
  breadcrumbSchema,
  ...(isWebApp
    ? [webApplicationSchema, webSiteSchema, howToSchema].filter(Boolean)
    : []),
];
---

{
  schemas.map((schema) => (
    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify(schema, null, 0)}
    />
  ))
}
