---
import iconUrl from "@/assets/icon.svg?no-inline";
import ogImageUrl from "@/assets/og-image.png?url";
import { siteConfig } from "@/lib/site-config";
import type { Feature, PricingTier } from "@/types";

interface Breadcrumb {
  name: string;
  path: string;
}

interface BaseProps {
  breadcrumbs: Breadcrumb[];
}

type WebsiteProps = BaseProps & { type: "website" };
type WebAppProps = BaseProps & {
  type: "webapp";
  pricingTiers: PricingTier[];
  features: Feature[];
};
type Props = WebsiteProps | WebAppProps;

const props = Astro.props;
const { breadcrumbs } = props;
const isWebApp = props.type === "webapp";

const siteUrl = Astro.site!.href;
const ogImageURL = new URL(ogImageUrl, Astro.site!).href;
const logoURL = new URL(iconUrl, Astro.site!).href;

const authorSchema = {
  "@type": "Person",
  name: siteConfig.author.name,
  url: siteConfig.author.website,
  sameAs: [
    `https://x.com/${siteConfig.author.twitter.replace("@", "")}`,
    `https://github.com/${siteConfig.author.github}`,
  ],
};

const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  name: siteConfig.name,
  url: siteUrl,
  logo: logoURL,
  description: siteConfig.description,
  founder: authorSchema,
  sameAs: [siteConfig.links.chromeWebStore],
};

const offers = isWebApp
  ? props.pricingTiers.map((tier) => ({
      "@type": "Offer",
      name: tier.name,
      price: tier.price,
      priceCurrency: siteConfig.pricing.currency,
      description: tier.features.join(", "),
    }))
  : [];

const featureList = isWebApp
  ? props.features.map((feature) => feature.title)
  : [];

const webApplicationSchema = {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  name: siteConfig.name,
  description: siteConfig.description,
  url: siteUrl,
  applicationCategory: "BrowserApplication",
  operatingSystem: "Windows, macOS, Linux, Chrome OS",
  browserRequirements:
    "Requires a Chromium-based browser (e.g. Chrome, Edge, Brave)",
  offers,
  featureList,
  downloadUrl: siteConfig.links.chromeWebStore,
  installUrl: siteConfig.links.chromeWebStore,
  screenshot: ogImageURL,
  author: authorSchema,
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: breadcrumbs.map((item, index) => ({
    "@type": "ListItem",
    position: index + 1,
    name: item.name,
    item: new URL(item.path, Astro.site!).href,
  })),
};

const webSiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: siteConfig.name,
  url: siteUrl,
  description: siteConfig.description,
  publisher: {
    "@type": "Organization",
    name: siteConfig.name,
  },
};

const schemas = [
  organizationSchema,
  breadcrumbSchema,
  ...(isWebApp ? [webApplicationSchema, webSiteSchema] : []),
];
---

{
  schemas.map((schema) => (
    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify(schema, null, 0)}
    />
  ))
}
