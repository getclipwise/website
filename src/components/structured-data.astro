---
import iconUrl from "@/assets/icon.svg?no-inline";
import ogImageUrl from "@/assets/og-image.png?url";
import screenshot01 from "@/assets/screenshots/01.png";
import screenshot02 from "@/assets/screenshots/02.png";
import screenshot03 from "@/assets/screenshots/03.png";
import screenshot04 from "@/assets/screenshots/04.png";
import { siteConfig } from "@/lib/site-config";
import type { FAQ, Feature, PricingTier, Step } from "@/types";
import { getImage } from "astro:assets";

interface Breadcrumb {
  name: string;
  path: string;
}

interface BaseProps {
  breadcrumbs: Breadcrumb[];
}

type WebsiteProps = BaseProps & { type: "website" };
type WebAppProps = BaseProps & {
  type: "webapp";
  pricingTiers: PricingTier[];
  features: Feature[];
  steps: Step[];
  faqs: FAQ[];
};
type Props = WebsiteProps | WebAppProps;

const props = Astro.props;
const { breadcrumbs } = props;
const isWebApp = props.type === "webapp";

const siteUrl = Astro.site!.href;
const ogImageURL = new URL(ogImageUrl, Astro.site!).href;
const logoURL = new URL(iconUrl, Astro.site!).href;

const screenshotWidth = 1440;
const screenshotHeight = 900;

const screenshots = await Promise.all(
  [screenshot01, screenshot02, screenshot03, screenshot04].map((src) =>
    getImage({ src, width: screenshotWidth, height: screenshotHeight }),
  ),
);

// Entity ID generators
const authorId = () => `${siteConfig.author.website}#me`;
const logoId = () => `${siteUrl}#logo`;
const organizationId = () => `${siteUrl}#organization`;
const softwareId = () => `${siteUrl}#software`;
const screenshotId = (index: number) => `${siteUrl}#screenshot-${index + 1}`;
const websiteId = () => `${siteUrl}#website`;

// Entity reference generators
const authorRef = () => ({ "@id": authorId() });
const logoRef = () => ({ "@id": logoId() });
const organizationRef = () => ({ "@id": organizationId() });

// Reusable ImageObject for the logo
const logoImageSchema = {
  "@type": "ImageObject",
  "@id": logoId(),
  url: logoURL,
  width: "512",
  height: "512",
};

// Organization schema per https://schema.org/Organization
const organizationSchema = {
  "@type": "Organization",
  "@id": organizationId(),
  name: siteConfig.name,
  url: siteUrl,
  logo: logoImageSchema,
  description: siteConfig.description,
  founder: authorRef(),
  sameAs: [siteConfig.links.chromeWebStore],
};

// Offer schema per https://schema.org/Offer
const offers = isWebApp
  ? props.pricingTiers.map((tier) => ({
      "@type": "Offer",
      name: tier.name,
      description: tier.features.join(", "),
      price: tier.price.toString(),
      priceCurrency: siteConfig.pricing.currency,
      availability: "https://schema.org/InStock",
      url: `${siteUrl}#pricing`,
      seller: organizationRef(),
      priceSpecification: {
        "@type": "PriceSpecification",
        price: tier.price.toString(),
        priceCurrency: siteConfig.pricing.currency,
        valueAddedTaxIncluded: true,
      },
    }))
  : [];

const featureList = isWebApp
  ? props.features.map((feature) => feature.title)
  : [];

// WebApplication schema per https://schema.org/WebApplication
const webApplicationSchema = {
  "@type": "WebApplication",
  "@id": softwareId(),
  name: siteConfig.name,
  description: siteConfig.description,
  url: siteUrl,
  applicationCategory: "BrowserApplication",
  applicationSubCategory: "Productivity",
  operatingSystem: "Windows, macOS, Linux, Chrome OS",
  browserRequirements:
    "Requires a Chromium-based browser (e.g. Chrome, Edge, Brave)",
  offers,
  featureList,
  downloadUrl: siteConfig.links.chromeWebStore,
  installUrl: siteConfig.links.chromeWebStore,
  screenshot: screenshots.map((img, index) => {
    const screenshotUrl = new URL(img.src, siteUrl).href;
    return {
      "@type": "ImageObject",
      "@id": screenshotId(index),
      url: screenshotUrl,
      contentUrl: screenshotUrl,
      width: String(screenshotWidth),
      height: String(screenshotHeight),
    };
  }),
  image: logoRef(),
  author: authorRef(),
  publisher: organizationRef(),
  softwareHelp: {
    "@type": "WebPage",
    "@id": siteUrl,
    url: siteUrl,
    name: `${siteConfig.name} Help`,
  },
};

// BreadcrumbList schema per https://schema.org/BreadcrumbList
const breadcrumbSchema =
  breadcrumbs.length > 0
    ? {
        "@type": "BreadcrumbList",
        itemListElement: breadcrumbs.map((breadcrumb, index) => ({
          "@type": "ListItem",
          position: index + 1,
          item: {
            "@id": new URL(breadcrumb.path, Astro.site!).href,
            name: breadcrumb.name,
          },
        })),
      }
    : null;

// WebSite schema per https://schema.org/WebSite
const webSiteSchema = {
  "@type": "WebSite",
  "@id": websiteId(),
  name: siteConfig.name,
  url: siteUrl,
  description: siteConfig.description,
  publisher: organizationRef(),
  inLanguage: siteConfig.locale,
};

// HowTo schema per https://schema.org/HowTo
const howToSchema = isWebApp
  ? {
      "@type": "HowTo",
      name: "How to turn a webpage into AI-ready Markdown",
      description:
        "Extract the important content from any webpage and convert it to clean Markdown you can paste into AI tools in three simple steps",
      image: ogImageURL,
      totalTime: "PT1M",
      estimatedCost: {
        "@type": "MonetaryAmount",
        currency: siteConfig.pricing.currency,
        value: "0",
      },
      tool: [
        {
          "@type": "HowToTool",
          name: "Clipwise AI Chrome Extension",
        },
        {
          "@type": "HowToTool",
          name: "Chromium-based browser (Chrome, Edge, Brave)",
        },
      ],
      step: props.steps.map((step, index) => ({
        "@type": "HowToStep",
        position: String(index + 1),
        name: step.title,
        text: step.description,
        url: `${siteUrl}#how-it-works`,
      })),
    }
  : null;

// FAQPage schema per https://schema.org/FAQPage
const faqPageSchema = isWebApp
  ? {
      "@type": "FAQPage",
      mainEntity: props.faqs.map((faq) => ({
        "@type": "Question",
        name: faq.question,
        acceptedAnswer: {
          "@type": "Answer",
          text: faq.answer,
        },
      })),
    }
  : null;

const openGraphSchema = {
  "@context": "https://schema.org",
  "@graph": [
    organizationSchema,
    breadcrumbSchema,
    ...(isWebApp
      ? [webApplicationSchema, webSiteSchema, howToSchema, faqPageSchema]
      : []),
  ].filter(Boolean),
};
---

<script
  is:inline
  type="application/ld+json"
  set:html={JSON.stringify(openGraphSchema, null, 0)}
/>
